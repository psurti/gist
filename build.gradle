/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * User Manual available at https://docs.gradle.org/5.3.1/userguide/tutorial_java_projects.html
 */
plugins {
    // Apply the java plugin to add support for Java
    id 'java'

    // Apply the application plugin to add support for building an application
    id 'application'

   id 'com.adarshr.test-logger' version '2.0.0'

}

repositories {
    // Use jcenter for resolving your dependencies.
    // You can declare any Maven/Ivy/file repository here.
    jcenter()
}

apply from: 'modules/jackson.gradle'
apply from: 'modules/spring.gradle'
apply from: 'modules/test.gradle'

dependencies {
    // This dependency is found on compile classpath of this component and consumers.
    implementation 'com.google.guava:guava:27.0.1-jre'

    // Use JUnit test framework
    testImplementation 'junit:junit:4.12'
}

def styler = 'black red green yellow blue magenta cyan white'
        .split().toList().withIndex(30)
        .collectEntries { key, val -> [(key): { "\033[${val}m${it}\033[0m" }] }

def inputFiles = project.fileTree(dir: "src", include: "**/*.java")

/**
 * RunWith: gradle -ai test --continuous
 */
test {
    //inputFiles.each { println it }
    def app = inputFiles.sort{ it.lastModified() }.reverse().get(0)
    def idx = app.toString().indexOf("java\\")
    app =  app.toString().substring(idx+5);
    def appName = app.replace(".java","")
    println "${styler['yellow']("[Execute(test): "+ appName +"]")}"

    include appName + '**'

    testlogger {
        slowThreshold 0
        showPassed = true
        showSummary = true
        showStandardStreams = true

        afterSuite { desc, result ->
            if (!desc.parent) { // will match the outermost suite
                def output = "Results: ${result.resultType} (${result.testCount} tests, ${result.successfulTestCount} passed, ${result.failedTestCount} failed, ${result.skippedTestCount} skipped)"
                def startItem = '|  ', endItem = '  |'
                def repeatLength = startItem.length() + output.length() + endItem.length()
                println('\n' + ('-' * repeatLength) + '\n' + startItem + output + endItem + '\n' + ('-' * repeatLength))
            }
        }
    }
}
/**
 * RunWith: gradle -ai runx --continuous
 */
project.task("runx", type: JavaExec)  {
    inputs.files(inputFiles)
    def allInputFiles = inputs.getFiles().getFiles()
    //allInputFiles.each { println it }
    def app = allInputFiles.sort{ it.lastModified() }.reverse().get(0)
    def idx = app.toString().indexOf("java\\")
    app =  app.toString().substring(idx+5);
    def appName = app.replaceAll("\\\\", ".").replace(".java","")
    println "${styler['yellow']("[Execute(main): "+ appName +"]")}"

    classpath = sourceSets.main.runtimeClasspath
    main = appName
}